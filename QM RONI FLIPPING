<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>মাস্টার ফ্লিপবুক ক্রিয়েটর</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --bg: #1a1a1a; --panel: #2d2d2d; --accent: #3498db; --text: #ffffff; }
        [data-theme="light"] { --bg: #f0f0f0; --panel: #ffffff; --accent: #2980b9; --text: #333333; }

        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; overflow: hidden; transition: 0.3s; }
        
        /* Sidebar/Header Navigation */
        .sidebar { 
            position: fixed; left: 0; top: 0; bottom: 0; width: 60px; 
            background: var(--panel); display: flex; flex-direction: column; 
            align-items: center; py: 20px; gap: 20px; padding-top: 20px; z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
        }

        .side-btn { color: var(--text); font-size: 20px; cursor: pointer; transition: 0.3s; }
        .side-btn:hover { color: var(--accent); transform: scale(1.2); }

        /* Main Viewport */
        .main-content { margin-left: 60px; height: 100vh; position: relative; }

        .top-bar { 
            position: absolute; top: 15px; right: 20px; display: flex; gap: 10px; z-index: 100;
        }

        .book-area {
            height: 80vh; display: flex; justify-content: center; align-items: center; padding: 20px;
        }

        #flipbook-wrapper { display: none; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

        /* Thumbnails Strip */
        .thumbnails-container {
            position: fixed; bottom: 10px; left: 80px; right: 20px; height: 100px;
            background: rgba(0,0,0,0.2); display: flex; gap: 10px; overflow-x: auto;
            padding: 10px; border-radius: 10px; backdrop-filter: blur(5px);
        }
        .thumb-page { height: 80px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .thumb-page:hover { border-color: var(--accent); }

        .btn {
            background: var(--accent); color: white; border: none; padding: 10px 18px;
            border-radius: 5px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px;
        }

        .loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <i class="fas fa-file-upload side-btn" title="Upload PDF" onclick="document.getElementById('pdf-in').click()"></i>
        <i class="fas fa-lock side-btn" title="Set Password" onclick="setPassword()"></i>
        <i class="fas fa-share-alt side-btn" title="Share" onclick="shareBook()"></i>
        <i class="fas fa-palette side-btn" title="Change Background" onclick="document.getElementById('bg-in').click()"></i>
        <i class="fas fa-moon side-btn" id="theme-toggle" title="Night Mode" onclick="toggleTheme()"></i>
        <i class="fas fa-download side-btn" title="Download" onclick="downloadPDF()"></i>
    </div>

    <input type="file" id="pdf-in" accept="application/pdf" style="display:none">
    <input type="file" id="bg-in" accept="image/*" style="display:none">

    <div class="main-content">
        <div class="top-bar" id="brand-info">
            <span id="book-title">আমার ফ্লিপবুক লাইব্রেরি</span>
        </div>

        <div class="loading" id="loader">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
        </div>

        <div class="book-area">
            <div id="flipbook-wrapper"></div>
        </div>

        <!-- Thumbnails Area -->
        <div class="thumbnails-container" id="thumb-strip"></div>
    </div>

    <audio id="flip-sound" src="https://www.soundjay.com/misc/sounds/page-flip-01a.mp3"></audio>

    <script>
        let pageFlip = null;
        let pdfFile = null;
        let bookPassword = "";
        let currentTheme = "dark";

        const pdfIn = document.getElementById('pdf-in');
        const bgIn = document.getElementById('bg-in');
        const wrapper = document.getElementById('flipbook-wrapper');
        const thumbStrip = document.getElementById('thumb-strip');
        const loader = document.getElementById('loader');

        // ১. থিম টগল (Night Mode)
        function toggleTheme() {
            currentTheme = currentTheme === "dark" ? "light" : "dark";
            document.body.setAttribute('data-theme', currentTheme);
            document.getElementById('theme-toggle').className = currentTheme === "dark" ? "fas fa-moon side-btn" : "fas fa-sun side-btn";
        }

        // ২. পাসওয়ার্ড সেট করা
        function setPassword() {
            bookPassword = prompt("বইটির জন্য একটি পাসওয়ার্ড দিন (খালি রাখলে পাসওয়ার্ড লাগবে না):");
            alert(bookPassword ? "পাসওয়ার্ড সেট হয়েছে!" : "পাসওয়ার্ড রিমুভ হয়েছে।");
        }

        // ৩. ব্যাকগ্রাউন্ড ইমেজ পরিবর্তন
        bgIn.onchange = (e) => {
            const file = e.target.files[0];
            const url = URL.createObjectURL(file);
            document.body.style.backgroundImage = `url(${url})`;
            document.body.style.backgroundSize = "cover";
        };

        // ৪. PDF প্রসেসিং ও থাম্বনেইল জেনারেটর
        pdfIn.onchange = async (e) => {
            if(bookPassword) {
                const check = prompt("এই ফাইলটি প্রসেস করতে পাসওয়ার্ড দিন:");
                if(check !== bookPassword) { alert("ভুল পাসওয়ার্ড!"); return; }
            }

            const file = e.target.files[0];
            if(!file) return;
            pdfFile = file;
            loader.style.display = 'block';
            wrapper.innerHTML = '';
            thumbStrip.innerHTML = '';

            const reader = new FileReader();
            reader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    canvas.className = 'page-canvas';
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                    wrapper.appendChild(canvas);

                    // থাম্বনেইল তৈরি
                    const thumb = document.createElement('img');
                    thumb.src = canvas.toDataURL();
                    thumb.className = 'thumb-page';
                    thumb.onclick = () => pageFlip.flip(i-1);
                    thumbStrip.appendChild(thumb);
                }
                startFlipbook(pdf.numPages);
            };
            reader.readAsArrayBuffer(file);
        };

        function startFlipbook(total) {
            loader.style.display = 'none';
            wrapper.style.display = 'block';

            const firstCanvas = wrapper.querySelector('canvas');
            const ratio = firstCanvas.width / firstCanvas.height;
            const bHeight = window.innerHeight * 0.7;
            const bWidth = bHeight * ratio;

            pageFlip = new St.PageFlip(wrapper, {
                width: bWidth, height: bHeight,
                size: "stretch", showCover: true, useMouseEvents: true
            });

            pageFlip.loadFromHTML(document.querySelectorAll('.page-canvas'));
            pageFlip.on('flip', (e) => {
                document.getElementById('flip-sound').play();
            });
        }

        // ৫. শেয়ার ফাংশন
        function shareBook() {
            const url = window.location.href;
            const text = "আমার এই নতুন ফ্লিপবুকটি দেখুন!";
            window.open(`https://api.whatsapp.com/send?text=${text} ${url}`, '_blank');
        }

        // ৬. ডাউনলোড ফিক্সড
        function downloadPDF() {
            if(!pdfFile) return alert("প্রথমে PDF আপলোড করুন");
            const a = document.createElement('a');
            a.href = URL.createObjectURL(pdfFile);
            a.download = pdfFile.name;
            a.click();
        }
    </script>
</body>
</html>